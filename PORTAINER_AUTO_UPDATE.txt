Deploy Automatico no Portainer - Solucao Completa
==================================================

Esta solucao permite atualizar a app automaticamente sem ter de fazer build manual.

COMO FUNCIONA
-------------

1. Fazes push para o GitHub
2. GitHub Actions faz build automatico da imagem Docker
3. A imagem e enviada para GitHub Container Registry (ghcr.io)
4. Portainer faz pull da imagem atualizada automaticamente

PASSO 1: Ativar GitHub Container Registry
-------------------------------------------

1. Vai ao teu repositorio: https://github.com/jpxdpt/SGI
2. Vai a Settings -> Actions -> General
3. Em "Workflow permissions", escolhe "Read and write permissions"
4. Clica em "Save"

PASSO 2: Configurar GitHub Actions
------------------------------------

O ficheiro .github/workflows/docker-build.yml ja foi criado.

Faz commit e push:
   git add .github/workflows/docker-build.yml
   git commit -m "feat: adicionar GitHub Actions para build automatico"
   git push origin master

O GitHub Actions vai fazer build automaticamente!

PASSO 3: Obter Token de Acesso
--------------------------------

1. No GitHub, vai a Settings -> Developer settings -> Personal access tokens -> Tokens (classic)
2. Clica em "Generate new token (classic)"
3. Nome: "Portainer Docker Pull"
4. Permissoes: apenas "read:packages"
5. Gera o token e copia (so aparece uma vez!)

PASSO 4: Configurar Portainer
------------------------------

1. No Portainer, vai a "Registries" -> "Add registry"
2. Escolhe "Docker Hub"
3. Name: "ghcr"
4. Username: teu-username-do-github
5. Password: o token que geraste no passo 3
6. Registry URL: ghcr.io
7. Clica em "Create registry"

PASSO 5: Criar Stack no Portainer
----------------------------------

No Portainer, cria uma nova stack com Web Editor:

   version: '3.8'
   
   services:
     backend:
       image: ghcr.io/jpxdpt/sgi/sgi-backend:latest
       ports:
         - "5801:5801"
       environment:
         - DATABASE_URL=postgresql://neondb_owner:npg_RgD2x5QBZUMd@ep-little-band-absv82a0-pooler.eu-west-2.aws.neon.tech/neondb?sslmode=require&channel_binding=require
         - JWT_SECRET=cc02d2f9edea2fa25de385eb061da48db5a3956e42a05c834cfb194fca9f8608
         - JWT_REFRESH_SECRET=ecc63e21c4cd7642f68bd2ad947a9953f66063d74d145622eca1b07ba5636975
         - DEFAULT_TENANT_ID=tenant-default
         - PORT=5801
         - NODE_ENV=production
         - ALLOW_ALL_ORIGINS=true
         - BASE_PATH=/api
       volumes:
         - sgi-uploads:/app/uploads
         - sgi-reports:/app/reports
       restart: unless-stopped
       pull_policy: always
   
   volumes:
     sgi-uploads:
     sgi-reports:

IMPORTANTE: O "pull_policy: always" faz com que o Portainer sempre puxe a versao mais recente!

PASSO 6: Atualizar App
-----------------------

Agora, sempre que fizeres alteracoes:

1. Faz commit e push para GitHub:
   git add .
   git commit -m "feat: atualizacao"
   git push origin master

2. GitHub Actions faz build automatico (vai a Actions no GitHub para ver)

3. No Portainer, clica em "Editor" na stack e depois "Update the stack"
   (Isto vai fazer pull da nova imagem)

OU configura webhook para atualizar automaticamente (avancado).

ALTERNATIVA: Docker Hub (Mais Simples)
---------------------------------------

Se preferires Docker Hub (mais simples de configurar):

1. Cria conta no Docker Hub: https://hub.docker.com
2. No GitHub Actions, muda REGISTRY para docker.io
3. Adiciona secrets no GitHub:
   - DOCKER_USERNAME
   - DOCKER_PASSWORD
4. No Portainer, adiciona registry do Docker Hub
5. Usa imagem: docker.io/seu-username/sgi-backend:latest

VANTAGENS
---------

- Build automatico a cada push
- Sem necessidade de fazer build manual
- Imagens versionadas no registry
- Facil de reverter para versao anterior
- Portainer sempre tem a versao mais recente

TROUBLESHOOTING
---------------

Problema: GitHub Actions falha
Solucao: Verifica os logs em Actions no GitHub
         Verifica que as permissoes estao corretas

Problema: Portainer nao consegue fazer pull
Solucao: Verifica que o registry esta configurado
         Verifica que o token esta correto
         Verifica que a imagem existe em ghcr.io/jpxdpt/sgi/sgi-backend

Problema: Imagem nao atualiza
Solucao: Usa "pull_policy: always" no docker-compose
         Ou faz "Update the stack" manualmente no Portainer

DICAS
-----

1. Verifica sempre os logs do GitHub Actions apos push
2. A primeira vez pode demorar mais (build completo)
3. Builds seguintes sao mais rapidos (cache)
4. Podes ver as imagens em: https://github.com/jpxdpt/SGI/pkgs/container/sgi-backend

Se precisares de ajuda, avisa!

